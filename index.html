<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Single Timer (Apps Script)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      display: flex; flex-direction: column;
      height: 100vh;
      background-color: #f0f0f0;
    }
    header {
      display: flex; align-items: center;
      background-color: #4CAF50; color: white;
      padding: 1rem;
    }
    header button {
      background: transparent; border: none;
      color: white; font-size: 1rem; margin-right: 1rem;
      cursor: pointer;
    }
    h1 { margin: 0; }
    .main-content {
      flex: 1;
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      text-align: center;
      padding: 1rem;
    }
    .time-remaining {
      font-size: 1.2rem;
      margin: 0.5rem 0;
    }
    .progress-bar-wrapper {
      width: 80%; max-width: 400px;
      background-color: #ddd;
      border-radius: 8px;
      overflow: hidden; margin-top: 1rem; height: 25px;
    }
    .progress-bar-fill {
      background-color: #4caf50;
      height: 100%;
      width: 0%;
      transition: width 0.25s;
    }
    /* Modal Overlay */
    .modal-overlay {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: none; /* hidden by default */
      align-items: center; justify-content: center;
      z-index: 999;
    }
    .modal {
      background-color: #fff;
      border-radius: 8px; padding: 1.5rem;
      max-width: 300px; width: 80%;
    }
    .modal h3 {
      margin-top: 0;
    }
    .modal p { margin: 1rem 0; }
    .modal label {
      display: block; margin: 0.5rem 0 0.2rem 0;
    }
    .modal input, .modal select {
      width: 100%; padding: 0.5rem; margin-bottom: 1rem;
    }
    .modal button {
      margin-right: 0.5rem; padding: 0.5rem 1rem; cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <button onclick="handleAddNew()">Add New</button>
    <h1>Single Timer</h1>
  </header>

  <!-- Main content -->
  <div class="main-content">
    <div class="time-remaining" id="timeRemaining">Loading...</div>
    <div class="progress-bar-wrapper">
      <div class="progress-bar-fill" id="progressFill"></div>
    </div>
  </div>

  <!-- Timer Input Modal -->
  <div class="modal-overlay" id="timerModalOverlay">
    <div class="modal">
      <h3>Set Timer</h3>
      <label>Enter Number:</label>
      <input type="number" id="durationInput" placeholder="e.g. 10" />
      <label>Unit:</label>
      <select id="unitSelect">
        <option value="year">Year</option>
        <option value="month">Month</option>
        <option value="week">Week</option>
        <option value="day" selected>Day</option>
        <option value="hour">Hour</option>
      </select>
      <button onclick="confirmTimerCreate()">Create</button>
      <button onclick="closeTimerModal()">Cancel</button>
    </div>
  </div>

  <!-- Confirm Modal (for center-screen confirmations) -->
  <div class="modal-overlay" id="confirmOverlay">
    <div class="modal">
      <h3 id="confirmTitle">Confirm</h3>
      <p id="confirmMessage">Are you sure?</p>
      <button id="confirmYesBtn">Yes</button>
      <button id="confirmNoBtn">No</button>
    </div>
  </div>

  <script>
    let updateInterval = null;
    let timerData = null; // We'll store {startTime, endTime, totalMs} once loaded

    document.addEventListener('DOMContentLoaded', () => {
      // Fetch any existing timer from server on load
      google.script.run
        .withSuccessHandler(function(dataStr) {
          if (dataStr) {
            // We have existing data
            timerData = JSON.parse(dataStr);
            startTimerLoop(timerData);
          } else {
            // No timer set
            document.getElementById('timeRemaining').textContent = "No timer set.";
          }
        })
        .getTimerData();
    });

    /* ==================================
       ADD NEW TIMER FLOW
    ================================== */
    function handleAddNew() {
      showConfirmModal(
        "Add New Timer",
        "Do you really want to add a new timer? (This will delete the old one.)",
        () => {
          // YES => Clear timer on server
          google.script.run
            .withSuccessHandler(function() {
              // Reset local display
              document.getElementById('timeRemaining').textContent = "No timer set.";
              document.getElementById('progressFill').style.width = '0%';
              if (updateInterval) clearInterval(updateInterval);
              timerData = null;
              // Show the input modal
              openTimerModal();
            })
            .clearTimerData();
        },
        () => {
          // NO => do nothing
        }
      );
    }

    /* ==================================
       TIMER MODAL
    ================================== */
    function openTimerModal() {
      document.getElementById('timerModalOverlay').style.display = 'flex';
      document.getElementById('durationInput').value = '';
      document.getElementById('unitSelect').value = 'day';
    }
    function closeTimerModal() {
      document.getElementById('timerModalOverlay').style.display = 'none';
    }

    // When "Create" is clicked in the modal
    function confirmTimerCreate() {
      const duration = document.getElementById('durationInput').value;
      const unit = document.getElementById('unitSelect').value;
      if (!duration || isNaN(duration) || duration <= 0) {
        alert("Please enter a valid number.");
        return;
      }
      let label = `${duration} ${unit}`;
      showConfirmModal(
        "Create Timer",
        `Are you sure you want to create ${label} timer?`,
        () => {
          // YES => actually create
          closeTimerModal();
          createTimer(duration, unit);
        },
        () => {
          // NO => do nothing
        }
      );
    }

    // Actually create the timer (on the server)
    function createTimer(duration, unit) {
      const now = new Date();
      let end = new Date(now);

      switch (unit) {
        case 'year':  end.setFullYear(end.getFullYear() + parseInt(duration)); break;
        case 'month': end.setMonth(end.getMonth() + parseInt(duration)); break;
        case 'week':  end.setDate(end.getDate() + (parseInt(duration) * 7)); break;
        case 'day':   end.setDate(end.getDate() + parseInt(duration)); break;
        case 'hour':  end.setHours(end.getHours() + parseInt(duration)); break;
        default:      end.setDate(end.getDate() + parseInt(duration));
      }

      const startTime = now.getTime();
      const endTime = end.getTime();
      const totalMs = endTime - startTime;

      const newTimer = {
        startTime: startTime,
        endTime: endTime,
        totalMs: totalMs
      };
      const newTimerStr = JSON.stringify(newTimer);

      // Save on server
      google.script.run
        .withSuccessHandler(function(response) {
          // Now load it into our UI
          timerData = newTimer;
          startTimerLoop(timerData);
        })
        .setTimerData(newTimerStr);
    }

    /* ==================================
       COUNTDOWN & PROGRESS
    ================================== */
    function startTimerLoop(data) {
      if (updateInterval) clearInterval(updateInterval);
      updateUI(data); // immediate
      updateInterval = setInterval(() => {
        updateUI(data);
      }, 1000);
    }

    function updateUI(data) {
      const now = Date.now();
      let remainMs = data.endTime - now;
      if (remainMs < 0) remainMs = 0;

      // d/h/m/s
      let seconds = Math.floor(remainMs / 1000);
      let minutes = Math.floor(seconds / 60);
      let hours = Math.floor(minutes / 60);
      let days = Math.floor(hours / 24);

      seconds = seconds % 60;
      minutes = minutes % 60;
      hours = hours % 24;

      let displayStr = '';
      if (days > 0) displayStr += days + 'd ';
      if (hours > 0) displayStr += hours + 'h ';
      if (minutes > 0) displayStr += minutes + 'm ';
      displayStr += seconds + 's';

      if (remainMs <= 0) {
        document.getElementById('timeRemaining').textContent = "Time is up!";
      } else {
        document.getElementById('timeRemaining').textContent = displayStr + " remaining";
      }

      // progress
      let elapsedMs = data.totalMs - remainMs;
      let percent = (elapsedMs / data.totalMs) * 100;
      if (percent > 100) percent = 100;
      document.getElementById('progressFill').style.width = percent + '%';
    }

    /* ==================================
       CUSTOM CONFIRM MODAL
    ================================== */
    function showConfirmModal(title, message, onYes, onNo) {
      const overlay = document.getElementById('confirmOverlay');
      const titleElem = document.getElementById('confirmTitle');
      const messageElem = document.getElementById('confirmMessage');
      const yesBtn = document.getElementById('confirmYesBtn');
      const noBtn = document.getElementById('confirmNoBtn');

      titleElem.textContent = title;
      messageElem.textContent = message;

      // Clear old handlers
      yesBtn.onclick = null;
      noBtn.onclick = null;

      yesBtn.onclick = () => {
        overlay.style.display = 'none';
        if (typeof onYes === 'function') onYes();
      };
      noBtn.onclick = () => {
        overlay.style.display = 'none';
        if (typeof onNo === 'function') onNo();
      };

      overlay.style.display = 'flex';
    }
  </script>
</body>
</html>
